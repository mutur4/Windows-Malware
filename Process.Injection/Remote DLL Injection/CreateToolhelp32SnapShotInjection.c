#include <windows.h>
#include <tlhelp32.h>
#include <stdio.h>
#include <tchar.h>

INT ReturnProcess(WCHAR* procName) {
	PROCESSENTRY32 pe32;
	INT pid = 0;
	HANDLE hSnap = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, 0);

	pe32.dwSize = sizeof(PROCESSENTRY32);

	if (hSnap == INVALID_HANDLE_VALUE) goto end;
	if (!Process32First(hSnap, &pe32)) goto end;


	do {
		if (wcscmp(pe32.szExeFile, procName) == 0) {
			pid = pe32.th32ProcessID;
			break;
		}
	} while (Process32Next(hSnap, &pe32));
	return pid;

end:
	CloseHandle(hSnap);
	return -1;
}

INT main(INT argc, CHAR** argv) {
	LPVOID pLoadLibrary = NULL;
	PWSTR dllName = L"C:\\Users\\ManFile\\Desktop\\dll\\x64\\Release\\dll.dll";
	DWORD dwSize = wcslen(dllName) * sizeof(WCHAR);

	
	int pid = ReturnProcess(L"notepad.exe");
	
	//Obviously Notepad.exe cannot have 0 PID XD
	if (pid < 0 || !pid) goto end;
	_tprintf(TEXT("[+] Returned Process ID: %d\n"), pid);

	//open the process to be able to write and manipulate its memory permissions
	HANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, pid);

	//Get the address of LoadLibrary will be the same as that of the RemoteProcess
	pLoadLibrary = GetProcAddress(GetModuleHandle(L"kernel32.dll"), "LoadLibraryW");
	_tprintf(TEXT("[+] LoadLibraryW address: %p\n"), pLoadLibrary);

	//allocate a space for writing the string in memory and the size doesn't matter, VAlloc() will always allocate a PAGE size 4KB in size 
	LPVOID pRemoteAddress = VirtualAllocEx(hProcess, NULL, dwSize, MEM_COMMIT|MEM_RESERVE, PAGE_READWRITE);

	_tprintf(TEXT("[+] Remote Address allocated @ %p\n"), pRemoteAddress);
	SIZE_T dwSizeIn;

	WriteProcessMemory(hProcess, pRemoteAddress, dllName, dwSize, &dwSizeIn);
	_tprintf(TEXT("[+] Wrote %d/%d-bytes in memory\n"), dwSizeIn, dwSize);

	HANDLE hThread = CreateRemoteThread(hProcess, NULL, NULL, pLoadLibrary, pRemoteAddress, NULL, NULL);
	if (hThread == NULL) {
		_tprintf("[!] CreateRemoteThread failed with error: %d\n", GetLastError());
		goto end;
	}
	_tprintf(TEXT("[+] ThreadExecution complete!\n"));
	return 0;

	end:
	    return -1;
}
